<!doctype html>
<html lang="ja">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>14言語 → 17言語 変換（km/lo/ne追加）</title>
<style>
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto;max-width:1100px;margin:24px auto;padding:0 12px;}
  h1{font-size:20px;margin:0 0 12px}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  textarea{width:100%;height:420px;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;padding:10px;border:1px solid #ccc;border-radius:8px}
  .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .small{font-size:12px;color:#555}
  button{padding:10px 14px;border-radius:8px;border:1px solid #888;background:#111;color:#fff;cursor:pointer}
  button:hover{opacity:.9}
  input[type="file"]{border:1px dashed #aaa;padding:8px;border-radius:8px;background:#fafafa}
  .pill{padding:6px 10px;border:1px solid #ddd;border-radius:999px;background:#f6f6f6}
</style>
<h1>14言語 → 17言語 変換（km/lo/ne追加）</h1>

<div class="bar">
  <label class="pill"><input type="checkbox" id="fallbackEn" checked> km/lo/ne の空欄は英語（en）で埋める</label>
  <label class="pill">用語集CSV（任意）：<input type="file" id="csv" accept=".csv"></label>
  <button id="run">変換する</button>
  <button id="download">右側をJSON保存</button>
  <span class="small">キー順は：en, zh, ko, vi, es, fr, de, it, pt, id, tl, th, ru, hi, km, lo, ne</span>
</div>

<div class="row">
  <div>
    <p class="small">左：旧JSON（配列）を貼る</p>
    <textarea id="input" placeholder='[ { "id":"...", "jp":{"orth":"犬","reading":"いぬ"}, "defs":{...14言語...}, "pos":"noun" } ]'></textarea>
  </div>
  <div>
    <p class="small">右：新JSON（km/lo/ne追加後）</p>
    <textarea id="output" placeholder="ここに結果が出ます"></textarea>
  </div>
</div>

<script>
const LANG_ORDER = ["en","zh","ko","vi","es","fr","de","it","pt","id","tl","th","ru","hi","km","lo","ne"];

function parseCSV(text){
  // かなりシンプルなCSVパーサ（カンマ区切り、ダブルクォート未対応でも使える想定）
  const lines = text.replace(/\r/g,'').split('\n').filter(l=>l.trim()!=="");
  if(lines.length===0) return {};
  const header = lines[0].split(',').map(s=>s.trim());
  const idx = {orth: header.indexOf('orth'), km: header.indexOf('km'), lo: header.indexOf('lo'), ne: header.indexOf('ne')};
  const map = {};
  for(let i=1;i<lines.length;i++){
    const cols = lines[i].split(',').map(s=>s.trim());
    const orth = cols[idx.orth] || "";
    if(!orth) continue;
    map[orth] = {
      km: (idx.km>=0? cols[idx.km] : "") || "",
      lo: (idx.lo>=0? cols[idx.lo] : "") || "",
      ne: (idx.ne>=0? cols[idx.ne] : "") || ""
    };
  }
  return map;
}

function orderedDefs(defs){
  const out = {};
  LANG_ORDER.forEach(k=>{ if(k in defs) out[k]=defs[k]; });
  // 既存のその他キーは最後に付け足す
  Object.keys(defs).forEach(k=>{ if(!(k in out)) out[k]=defs[k]; });
  return out;
}

function convert(items, glossary, fallbackEn){
  return items.map(item=>{
    const jp = item.jp || {};
    const orth = (jp.orth||"").trim();
    const defs = Object.assign({}, item.defs||{});

    // 用語集があれば優先
    if(orth && glossary[orth]){
      ["km","lo","ne"].forEach(lang=>{
        const val = (glossary[orth][lang]||"").trim();
        if(val) defs[lang]=val;
      });
    }
    // まだ空ならフォールバック
    ["km","lo","ne"].forEach(lang=>{
      if(!defs[lang]){
        defs[lang] = fallbackEn ? (defs.en||"") : "";
      }
    });

    return {
      id: item.id,
      jp,
      defs: orderedDefs(defs),
      pos: item.pos
    };
  });
}

let glossaryMap = {};
document.getElementById('csv').addEventListener('change', async (e)=>{
  const file = e.target.files[0];
  if(!file) { glossaryMap = {}; return; }
  const text = await file.text();
  glossaryMap = parseCSV(text);
  alert('用語集を読み込みました（'+Object.keys(glossaryMap).length+' 件）');
});

document.getElementById('run').addEventListener('click', ()=>{
  try{
    const input = document.getElementById('input').value.trim();
    if(!input) { alert('左に旧JSON（配列）を貼ってください'); return; }
    const data = JSON.parse(input);
    const items = Array.isArray(data) ? data : (data.items||[]);
    if(!Array.isArray(items) || items.length===0) { alert('配列が見つかりません'); return; }

    const fallbackEn = document.getElementById('fallbackEn').checked;
    const out = convert(items, glossaryMap, fallbackEn);
    document.getElementById('output').value = JSON.stringify(out, null, 2);
  }catch(err){
    alert('エラー：'+err.message);
  }
});

document.getElementById('download').addEventListener('click', ()=>{
  const txt = document.getElementById('output').value;
  if(!txt){ alert('右側に出力がありません'); return; }
  const blob = new Blob([txt], {type:'application/json;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'converted.json';
  a.click();
  URL.revokeObjectURL(a.href);
});
</script>
